{% extends "base.html" %}

{% block title %}Brevify - YouTube Learning Assistant{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Hero Section -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">Transform YouTube into Your Learning Assistant</h1>
        <p class="text-light-secondary dark:text-dark-secondary text-xl">
            Turn any YouTube channel into an interactive learning experience with AI-powered insights
        </p>
    </div>

    <!-- Channel URL Input -->
    <div class="bg-light-card dark:bg-dark-card rounded-xl shadow-sm p-6 mb-8">
        <form hx-post="http://localhost:8888/fetch-videos" 
              hx-target="#video-list" 
              hx-indicator="#loading"
              class="space-y-4">
            
            <div>
                <label for="channel_url" class="block text-sm font-medium mb-2">
                    YouTube Channel URL
                </label>
                <input type="text" 
                       id="channel_url" 
                       name="channel_url" 
                       required
                       placeholder="https://www.youtube.com/c/channelname"
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 
                              bg-white dark:bg-gray-700 
                              focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 
                              focus:border-transparent">
            </div>

            <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg
                           transition-colors duration-200 ease-in-out">
                Load Channel Videos
            </button>
        </form>

        <!-- Error Message -->
        <div id="error-message" class="mt-4 text-red-600 dark:text-red-400 text-sm hidden"></div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="htmx-indicator flex justify-center items-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- Video List -->
    <div id="video-list" class="space-y-6">
        <!-- Videos will be loaded here -->
    </div>
</div>

<script>
    document.body.addEventListener('htmx:responseError', function(evt) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = evt.detail.error || 'An error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    });

    // Handle clicks on AI analysis links
    document.body.addEventListener('click', function(evt) {
        const link = evt.target.closest('a[href^="brevify://"]');
        if (!link) return;
        
        evt.preventDefault();
        const url = new URL(link.href);
        const aiTool = url.protocol.replace('brevify:', '').replace('//', '');
        const text = decodeURIComponent(url.searchParams.get('text'));
        
        if (!text) {
            console.error('No transcript found in URL');
            return;
        }

        // Send message to the page which will be picked up by the extension
        window.postMessage({
            type: 'BREVIFY_ANALYZE',
            payload: {
                tool: aiTool,
                text: text
            }
        }, '*');
    });

    // Show error if extension not found
    function showExtensionError() {
        const message = 'The Brevify extension is required to analyze transcripts. Please install it from the Chrome Web Store.';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }

    // Check if extension exists
    window.postMessage({ type: 'BREVIFY_CHECK' }, '*');
    const checkTimeout = setTimeout(showExtensionError, 1000);

    // Listen for extension response
    window.addEventListener('message', function(event) {
        if (event.data?.type === 'BREVIFY_RESPONSE') {
            clearTimeout(checkTimeout);
        }
    });
</script>
{% endblock %}
